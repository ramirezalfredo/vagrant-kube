---

- name: K8s | Reset Kubernetes component
  become: yes
  shell: "kubeadm reset -f"

- name: K8s | pull required images
  become: yes
  shell: kubeadm config images pull
  run_once: true

- name: K8s | Init Kubernetes cluster with {{ network }}
  become: yes
  shell: kubeadm init --pod-network-cidr {{ pod_network_cidr }}
  register: kubeadm_init

- name: K8s | Create Kubernetes config directory
  file: path="~/.kube/" state=directory

- name: k8s | Copy admin.conf to .kube/config
  become: yes
  command: cp {{ kubeadmin_config }} /home/{{ ansible_user }}/.kube/config

- name: K8s | Set permissions to admin.conf in Home directory
  become: yes
  file:
    path: "/home/{{ ansible_user }}/.kube/config"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0644

- name: K8s | Install flannel networking
  when: network == "flannel"
  shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

- name: K8s | Install etcd instance for calico
  when: network == "calico"
  shell: kubectl apply -f https://docs.projectcalico.org/v3.5/getting-started/kubernetes/installation/hosted/etcd.yaml

- name: K8s | Install calico networking
  when: network == "calico"
  shell: kubectl apply -f https://docs.projectcalico.org/v3.5/getting-started/kubernetes/installation/hosted/calico.yaml

# - debug: var=kubeadm_init
- debug: msg="{{ kubeadm_init.stdout_lines[62] }}"