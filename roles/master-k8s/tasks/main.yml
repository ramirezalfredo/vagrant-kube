---

- name: K8s | Reset Kubernetes component
  shell: "kubeadm reset -f"

- name: K8s | pull required images
  shell: kubeadm config images pull
  run_once: true

- name: K8s | Init Kubernetes cluster with {{ network }}
  shell: kubeadm init --pod-network-cidr {{ pod_network_cidr }}
  register: kubeadm_init

# - debug: var=ansible_facts
- debug: var=kubeadm_init

- name: K8s | Create Kubernetes config directory
  become: false
  file: path="~/.kube/" state=directory

- name: k8s | Copy admin.conf to .kube/config
  command: cp {{ kubeadmin_config }} /home/{{ ansible_user }}/.kube/config

- name: k8s | Set permissions to config
  command: chown {{ ansible_user }}:{{ ansible_user }} /home/{{ ansible_user }}/.kube/config

# - name: K8s | Copy admin.conf to Home directory
#   #when: init_cluster and ansible_user is defined
#   copy:
#     src: "{{ kubeadmin_config }}"
#     dest: "/home/ec2-user/.kube/config"
#     owner: ec2-user
#     group: ec2-user
#     mode: 0644

- name: K8s | Enable and restart kubelet engine
  systemd:
    name: kubelet
    daemon_reload: yes
    state: restarted
    enabled: yes
  notify:
    - restart kubelet

- name: K8s | Install {{ network }} SDN
  when: network == "flannel"
  become: false
  shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

- name: K8s | Install etcd instance
  when: network == "calico"
  become: false
  shell: kubectl apply -f https://docs.projectcalico.org/v3.5/getting-started/kubernetes/installation/hosted/etcd.yaml

- name: K8s | Install {{ network }} SDN
  when: network == "calico"
  become: false
  shell: kubectl apply -f https://docs.projectcalico.org/v3.5/getting-started/kubernetes/installation/hosted/calico.yaml
